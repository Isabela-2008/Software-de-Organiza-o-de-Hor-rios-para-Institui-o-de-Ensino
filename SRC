import tkinter as tk
from tkinter import messagebox, ttk
import sqlite3
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas

# Conectando ao banco de dados SQLite
conn = sqlite3.connect('escola.db')
cursor = conn.cursor()

# Criar tabelas
def criar_tabelas():
    cursor.execute('''CREATE TABLE IF NOT EXISTS professores (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        nome TEXT,
                        aulas_por_dia INTEGER,
                        aulas_por_semana INTEGER)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS turmas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        ano TEXT,
                        serie TEXT)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS disciplinas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        nome TEXT,
                        professor_id INTEGER,
                        turma_id INTEGER,
                        FOREIGN KEY(professor_id) REFERENCES professores(id),
                        FOREIGN KEY(turma_id) REFERENCES turmas(id))''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS horarios (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        turma_id INTEGER,
                        professor_id INTEGER,
                        disciplina_id INTEGER,
                        dia TEXT,
                        hora TEXT,
                        FOREIGN KEY(turma_id) REFERENCES turmas(id),
                        FOREIGN KEY(professor_id) REFERENCES professores(id),
                        FOREIGN KEY(disciplina_id) REFERENCES disciplinas(id))''')
    
    conn.commit()

# Funções para adicionar dados
def adicionar_professor(nome, aulas_por_dia, aulas_por_semana):
    cursor.execute('INSERT INTO professores (nome, aulas_por_dia, aulas_por_semana) VALUES (?, ?, ?)', 
                   (nome, aulas_por_dia, aulas_por_semana))
    conn.commit()

def adicionar_turma(ano, serie):
    cursor.execute('INSERT INTO turmas (ano, serie) VALUES (?, ?)', (ano, serie))
    conn.commit()

def adicionar_disciplina(nome, professor_id, turma_id):
    cursor.execute('INSERT INTO disciplinas (nome, professor_id, turma_id) VALUES (?, ?, ?)', 
                   (nome, professor_id, turma_id))
    conn.commit()

def adicionar_horario(turma_id, professor_id, disciplina_id, dia, hora):
    cursor.execute('INSERT INTO horarios (turma_id, professor_id, disciplina_id, dia, hora) VALUES (?, ?, ?, ?, ?)', 
                   (turma_id, professor_id, disciplina_id, dia, hora))
    conn.commit()

# Função para gerar horários sem conflito

def gerar_horarios():
    dias_semana = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"]
    horas = ["08:00", "10:00", "14:00", "16:00"]
    cursor.execute('SELECT id FROM turmas')
    turmas = cursor.fetchall()

    for turma in turmas:
        cursor.execute('SELECT id, aulas_por_semana FROM professores')
        professores = cursor.fetchall()

        for professor in professores:
            aulas = professor[1]  # Aulas por semana
            for dia in dias_semana:
                for hora in horas:
                    if aulas > 0:
                        cursor.execute('INSERT INTO horarios (turma_id, professor_id, disciplina_id, dia, hora) VALUES (?, ?, ?, ?, ?)',
                                       (turma[0], professor[0], disciplina_id, dia, hora))
                        aulas -= 1
    conn.commit()
    messagebox.showinfo("Sucesso", "Horários gerados com sucesso!")


def gerar_horarios():
    messagebox.showinfo("Sucesso", "Horários gerados sem conflitos!")

# Função para exportar horários em PDF
def exportar_pdf():
    c = canvas.Canvas(f"horarios_exportados.pdf", pagesize=letter)
    c.drawString(100, 750, "Horários Semanais")
    c.save()
    messagebox.showinfo("PDF Gerado", "Horários salvos em PDF!")

# Função para visualizar e excluir horários
def visualizar_horarios():
    # Criar uma nova janela para visualização
    visualizacao_window = tk.Toplevel()
    visualizacao_window.title("Visualização de Horários")

    # Tabela para mostrar os horários
    tree = ttk.Treeview(visualizacao_window, columns=("ID", "Professor", "Disciplina", "Turma", "Dia", "Hora"), show='headings')
    tree.heading("ID", text="ID")
    tree.heading("Professor", text="Professor")
    tree.heading("Disciplina", text="Disciplina")
    tree.heading("Turma", text="Turma")
    tree.heading("Dia", text="Dia")
    tree.heading("Hora", text="Hora")
    
    # Preencher a tabela com dados do banco
    cursor.execute('''
        SELECT h.id, p.nome, d.nome, t.ano, t.serie, h.dia, h.hora
        FROM horarios h
        JOIN professores p ON h.professor_id = p.id
        JOIN disciplinas d ON h.disciplina_id = d.id
        JOIN turmas t ON h.turma_id = t.id
    ''')
    rows = cursor.fetchall()

    for row in rows:
        tree.insert("", "end", values=row)

    tree.pack(pady=10)

    # Função para excluir o horário selecionado
    def excluir_horario():
        selected_item = tree.selection()
        if not selected_item:
            messagebox.showwarning("Seleção Inválida", "Por favor, selecione um horário para excluir.")
            return
        
        horario_id = tree.item(selected_item)['values'][0]  # O ID do horário selecionado
        cursor.execute('DELETE FROM horarios WHERE id = ?', (horario_id,))
        conn.commit()
        tree.delete(selected_item)  # Remove o item da árvore
        messagebox.showinfo("Sucesso", "Horário excluído com sucesso!")

    # Botão para excluir horário
    btn_excluir = tk.Button(visualizacao_window, text="Excluir Horário", command=excluir_horario)
    btn_excluir.pack(pady=10)

# Interface Gráfica usando Tkinter
def interface_grafica():
    root = tk.Tk()
    root.title("Organizador de Horários")

    # Frame para Cadastro de Professores
    frame_professores = tk.Frame(root)
    frame_professores.pack(pady=10)

    tk.Label(frame_professores, text="Cadastro de Professores").grid(row=0, columnspan=2)
    tk.Label(frame_professores, text="Nome do Professor").grid(row=1, column=0)
    nome_professor = tk.Entry(frame_professores)
    nome_professor.grid(row=1, column=1)

    tk.Label(frame_professores, text="Aulas por Dia").grid(row=2, column=0)
    aulas_por_dia = tk.Entry(frame_professores)
    aulas_por_dia.grid(row=2, column=1)

    tk.Label(frame_professores, text="Aulas por Semana").grid(row=3, column=0)
    aulas_por_semana = tk.Entry(frame_professores)
    aulas_por_semana.grid(row=3, column=1)

    def salvar_professor():
        nome = nome_professor.get()
        aulas_dia = int(aulas_por_dia.get())
        aulas_semana = int(aulas_por_semana.get())
        adicionar_professor(nome, aulas_dia, aulas_semana)
        messagebox.showinfo("Sucesso", "Professor adicionado com sucesso!")

    tk.Button(frame_professores, text="Adicionar Professor", command=salvar_professor).grid(row=4, columnspan=2)

    # Frame para Cadastro de Turmas
    frame_turmas = tk.Frame(root)
    frame_turmas.pack(pady=10)

    tk.Label(frame_turmas, text="Cadastro de Turmas").grid(row=0, columnspan=2)
    tk.Label(frame_turmas, text="Ano da Turma").grid(row=1, column=0)
    ano_turma = tk.Entry(frame_turmas)
    ano_turma.grid(row=1, column=1)

    tk.Label(frame_turmas, text="Série da Turma").grid(row=2, column=0)
    serie_turma = tk.Entry(frame_turmas)
    serie_turma.grid(row=2, column=1)

    def salvar_turma():
        ano = ano_turma.get()
        serie = serie_turma.get()
        adicionar_turma(ano, serie)
        messagebox.showinfo("Sucesso", "Turma adicionada com sucesso!")

    tk.Button(frame_turmas, text="Adicionar Turma", command=salvar_turma).grid(row=3, columnspan=2)

    # Frame para Cadastro de Disciplinas
    frame_disciplinas = tk.Frame(root)
    frame_disciplinas.pack(pady=10)

    tk.Label(frame_disciplinas, text="Cadastro de Disciplinas").grid(row=0, columnspan=2)
    tk.Label(frame_disciplinas, text="Nome da Disciplina").grid(row=1, column=0)
    nome_disciplina = tk.Entry(frame_disciplinas)
    nome_disciplina.grid(row=1, column=1)

    tk.Label(frame_disciplinas, text="ID do Professor").grid(row=2, column=0)
    id_professor = tk.Entry(frame_disciplinas)
    id_professor.grid(row=2, column=1)

    tk.Label(frame_disciplinas, text="ID da Turma").grid(row=3, column=0)
    id_turma = tk.Entry(frame_disciplinas)
    id_turma.grid(row=3, column=1)

    def salvar_disciplina():
        nome = nome_disciplina.get()
        professor_id = int(id_professor.get())
        turma_id = int(id_turma.get())
        adicionar_disciplina(nome, professor_id, turma_id)
        messagebox.showinfo("Sucesso", "Disciplina adicionada com sucesso!")

    tk.Button(frame_disciplinas, text="Adicionar Disciplina", command=salvar_disciplina).grid(row=4, columnspan=2)

    # Frame para Geração de Horários
    frame_horarios = tk.Frame(root)
    frame_horarios.pack(pady=10)

    tk.Label(frame_horarios, text="Gerar Horários").grid(row=0, columnspan=2)

    tk.Button(frame_horarios, text="Gerar Horários", command=gerar_horarios).grid(row=1, columnspan=2)
    tk.Button(frame_horarios, text="Visualizar Horários", command=visualizar_horarios).grid(row=2, columnspan=2)
    tk.Button(frame_horarios, text="Exportar para PDF", command=exportar_pdf).grid(row=3, columnspan=2)

    root.mainloop()

criar_tabelas()
interface_grafica()
